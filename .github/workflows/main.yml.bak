name: Test, Package, Publish
on:
  push:
    branches:
      - '*'
jobs:
  build-docker:
    runs-on: ubuntu-latest
    name: Build Docker Image
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: build docker image
        run: docker build --platform linux/amd64 -f build/package/docker/Dockerfile -t koldstart:latest .
      - name: save docker image
        run: docker save koldstart:latest | gzip > koldstart-docker-image.tgz
      - name: upload saved image as atifact
        uses: actions/upload-artifact@v3
        with:
          name: koldstart-docker-image
          path: koldstart-docker-image.tgz
  test:
    runs-on: ubuntu-latest
    name: Test
    needs: build-docker
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: download saved image
        uses: actions/download-artifact@v3
        with:
          name: koldstart-docker-image
      - name: install helm
        run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - name: install minikube
        run: curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && mv minikube-linux-amd64 /usr/local/bin/minikube && chmod +x /usr/local/bin/minikube
      - name: start minikube
        run: minikube start --driver=docker --kubernetes-version=v1.24.10
      - name: load docker image
        run: eval $(minikube docker-env); gunzip -c koldstart-docker-image.tgz | docker load
      - name: create test target deployment
        run: kubectl create deployment testtarget --image=ghcr.io/nginxinc/nginx-unprivileged:1.23-alpine --replicas=1 --port=8080
      - name: create test target service
        run: kubectl expose deployment testtarget --port=8080 --target-port=8080
      - name: helm install koldstart
        run: |
          helm install \
            -n default \
            koldstart \
            ./deployments/helm/koldstart \
            --set image.tag=latest \
            --set image.pullPolicy=Never \
            --set service.type=NodePort \
            --set "args[0]=-targetUrl=http://testtarget:8080"
      - name: wait for koldstart to be ready
        run: kubectl wait --for=condition=available --timeout=60s deployment/koldstart
      - name: test koldstart
        run: set -euo pipefail; curl -sSf $(minikube service koldstart --url) | grep "If you see this page, the nginx web server is successfully installed"
